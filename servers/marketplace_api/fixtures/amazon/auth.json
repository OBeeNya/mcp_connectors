{
  "scheme": "oauth2_lwa_plus_aws_sigv4",
  "description": "Amazon SP-API uses a two-layer auth: Login with Amazon (LWA) OAuth2 to obtain an access token, then AWS Signature Version 4 to sign every HTTP request.",
  "steps": [
    {
      "step": 1,
      "name": "LWA Token Exchange",
      "description": "Exchange your refresh_token for a short-lived access_token via LWA.",
      "endpoint": "https://api.amazon.com/auth/o2/token",
      "method": "POST",
      "content_type": "application/x-www-form-urlencoded",
      "body_params": {
        "grant_type": "refresh_token",
        "refresh_token": "{AMAZON_REFRESH_TOKEN}",
        "client_id": "{AMAZON_CLIENT_ID}",
        "client_secret": "{AMAZON_CLIENT_SECRET}"
      },
      "response": {
        "access_token": "Atza|...",
        "token_type": "bearer",
        "expires_in": 3600
      },
      "token_ttl_seconds": 3600,
      "caching_note": "Cache the access_token and refresh it proactively when within 60 seconds of expiry."
    },
    {
      "step": 2,
      "name": "AWS SigV4 Request Signing",
      "description": "Every API request must be signed using AWS Signature Version 4 with role credentials obtained via STS AssumeRole.",
      "sts_endpoint": "https://sts.amazonaws.com",
      "sts_action": "AssumeRole",
      "sts_params": {
        "RoleArn": "{AMAZON_ROLE_ARN}",
        "RoleSessionName": "connector-session",
        "DurationSeconds": 3600
      },
      "signing_params": {
        "algorithm": "AWS4-HMAC-SHA256",
        "service": "execute-api",
        "region": "us-east-1"
      },
      "required_headers": {
        "x-amz-access-token": "{lwa_access_token}",
        "x-amz-date": "{iso8601_datetime}",
        "Authorization": "AWS4-HMAC-SHA256 Credential=... SignedHeaders=... Signature=..."
      },
      "implementation_note": "Use the 'boto3' library or 'aws-requests-auth' to handle SigV4 signing. Do not implement signing manually."
    }
  ],
  "required_env_vars": [
    "AMAZON_CLIENT_ID",
    "AMAZON_CLIENT_SECRET",
    "AMAZON_REFRESH_TOKEN",
    "AMAZON_AWS_ACCESS_KEY_ID",
    "AMAZON_AWS_SECRET_ACCESS_KEY",
    "AMAZON_ROLE_ARN",
    "AMAZON_MARKETPLACE_ID",
    "AMAZON_SELLER_ID"
  ],
  "marketplace_ids": {
    "US": "ATVPDKIKX0DER",
    "CA": "A2EUQ1WTGCTBG2",
    "MX": "A1AM78C64UM0Y8",
    "UK": "A1F83G8C2ARO7P",
    "DE": "A1PA6795UKMFR9",
    "FR": "A13V1IB3VIYZZH",
    "IT": "APJ6JRA9NG5V4",
    "ES": "A1RKKUPIHCS9HS",
    "JP": "A1VC38T7YXB528",
    "AU": "A39IBJ37TRP1C6"
  },
  "sandbox": {
    "base_url": "https://sandbox.sellingpartnerapi-na.amazon.com",
    "uses_same_credentials": true,
    "note": "Sandbox returns static mocked responses. Use the test order IDs and ASINs listed in the SP-API sandbox documentation. Not all endpoints have sandbox support."
  },
  "libraries": {
    "python": ["python-amazon-sp-api", "boto3 (for STS/SigV4)"],
    "note": "The 'python-amazon-sp-api' library handles both LWA and SigV4 automatically."
  }
}
